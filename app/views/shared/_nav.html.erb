<% nav_links = {
    "Dashboard" => user_logged_in? ? home_path : login_path,
    "About Blueprint" => about_path,
    # "My Projects" => user_logged_in? ? projects_path : login_path,
    "Starter Projects" => starter_projects_path,
    "Design Resources" => resources_path,
    "Explore" => explore_path,
    "Leaderboard" => leaderboard_path,
    "Shop" => toolbag_path,
    "FAQ" => faq_path,
    "Admin" => current_user&.special_perms? ? admin_root_path : nil
} %>

<% active_projects_count = user_logged_in? ? Rails.cache.fetch([current_user.id, "active_projects_count", current_user.projects.maximum(:updated_at)]) { current_user.projects.where(is_deleted: false).count } : 0 %>
<% if active_projects_count > 5 %>
  <% nav_links = nav_links.to_a.insert(2, ["My Projects", projects_path]).to_h %>
<% end %>
<% submenu = ["About Blueprint", "Starter Projects", "Design Resources"] %>

<% normalize_path = ->(p) { p.to_s.sub(%r{/$}, "") } %>
<% req = normalize_path.call(request.path) %>
<% current_nav = nav_links.find { |_, path|
     p = normalize_path.call(path)
     p.present? && (req == p || req.start_with?("#{p}/"))
   }&.first %>

<nav id="global-nav" data-nav-target="panel" class="fixed inset-y-0 left-0 z-50 w-64 md:w-[15rem] bg-bp-darker flex flex-col py-8 px-6 print:hidden space-y-6 shadow-xl shadow-black/50 transform transition-transform duration-200 -translate-x-full md:translate-x-0 overflow-y-auto md:bottom-0 md:top-0 font-rc-full" aria-hidden="true">
    <div class="flex items-center justify-between md:block">
        <a class="text-center md:block" href="<%= user_logged_in? ? landing_path : root_path %>">
            <p class="text-3xl md:text-4xl font-rcgl-full">Blueprint</p>
        </a>
        <button type="button"
                class="p-2 -m-2 md:hidden"
                aria-label="Close menu"
                data-action="click->nav#close">
            <%= inline_svg "icons/close.svg", class: "size-6" %>
        </button>
    </div>
    <div class="flex flex-col space-y-3 grow">
        <% nav_links.each do |name, path| %>
            <% next if path.nil? %>
            <% has_submenu = submenu.include?(name) %>
            <% match = has_submenu ? "prefix" : "exact" %>
            <% submenu_base_path = has_submenu ? normalize_path.call(path) : nil %>
            <% active = current_nav == name %>

            <% if has_submenu && active %>
              <div class="flex flex-col btn btn-nav text-base submenu p-0 gap-0" data-nav-target="link" data-nav-match="prefix" data-nav-base="<%= submenu_base_path %>">
                <%= render "shared/button", url: path, text: name, variant: :none, class: "text-base p-0 hover:bg-bp-lighter w-full submenu-btn" %>
                <ul data-nav-target="submenu" data-submenu-base="<%= submenu_base_path %>" class="flex-col hidden w-full pb-3 text-sm text-center">
                  <% index_meta = meta_for_url(submenu_base_path, submenu_base_path) rescue nil %>
                  <% unless index_meta&.dig(:unlisted) %>
                    <li class="w-full">
                      <a href="<%= submenu_base_path %>" class="px-2 hover:bg-bp-lighter motion-safe:transition-colors block py-0.5" data-nav-target="sublink" data-nav-match="exact" title="<%= index_meta&.dig(:description) %>"><%= index_meta&.dig(:title) || "Start here" %></a>
                    </li>
                  <% end %>
                  <% items = menu_items_for(submenu_base_path) rescue [] %>
                  <% items.each do |item| %>
                    <li class="w-full">
                      <a href="<%= item[:path] %>" class="px-2 hover:bg-bp-lighter motion-safe:transition-colors block py-0.5" data-nav-target="sublink" data-nav-match="<%= item[:match] || 'prefix' %>" title="<%= item[:description] %>"><%= item[:title] %></a>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% else %>
              <%= render "shared/button", url: path, text: name, variant: active ? :nav_active : :nav, class: "text-base py-1.5 #{name == "Admin" ? "text-orange-400 border-orange-400" : ""}", html_options: { data: { nav_target: "link", nav_match: match } } %>
            <% end %>
        <% end %>
    </div>
    <% if user_logged_in? %>
        <div class="flex flex-col space-y-1">
            <% if session[:original_id] %>
                <%= button_to admin_stop_impersonating_path, method: :post, class: "text-bp-warning text-sm mb-2 cursor-pointer", form: { data: { turbo: false } } do %>
                    <span>Stop Impersonating</span>
                <% end %>
            <% end %>
            <%= link_to user_path(current_user), class: "flex items-center space-x-4" do %>
                <div class="flex items-center space-x-4">
                    <% avatar_url = current_user.avatar || "https://hc-cdn.hel1.your-objectstorage.com/s/v3/c283ae01214b9052480f1e216e43dbe09a424048_image.png" %>
                    <% name = current_user.display_name || current_user.email || "unknown" %>
                    <img src="<%= avatar_url %>" alt="<%= name %>'s avatar" class="rounded-lg size-12">
                    <div>
                        <p class="w-32 truncate whitespace-nowrap"><%= name %> <%= current_user.created_at < DateTime.new(2025,10,4,4,0,0) ? "ðŸš€" : "" %></p>
                        <% cache [current_user, "tickets-v2"] do %>
                          <p><%= pluralize(current_user.tickets, "ticket") %></p>
                        <% end %>
                    </div>
                </div>
            <% end %>
            <%= button_to logout_path , method: :delete, class: "flex items-center space-x-2" do %>
                <span>Log out</span>
                <%= inline_svg "icons/logout.svg", class: "size-2" %>
            <% end %>
        </div>
    <% else %>
        <%= render "shared/button", url: login_path(redirect_to: request.fullpath), text: "Log in" %>
    <% end %>
</nav>
