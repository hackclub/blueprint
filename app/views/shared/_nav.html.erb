<% nav_links = {
    "Home" => user_logged_in? ? home_path : login_path,
    "My Projects" => user_logged_in? ? projects_path : login_path,
    "Explore" => explore_path,
    "Tool Bag" => toolbag_path,
    "Guides" => guides_path,
    "Blueprint Docs" => docs_path,
    "Leaderboard" => leaderboard_path,
    "FAQ" => faq_path,
    "Admin" => current_user&.special_perms? ? admin_root_path : nil
} %>

<% normalize_path = ->(p) { p.to_s.sub(%r{/$}, "") } %>
<% req = normalize_path.call(request.path) %>
<% current_nav = nav_links.find { |_, path|
     p = normalize_path.call(path)
     p.present? && (req == p || req.start_with?("#{p}/"))
   }&.first %>

<nav id="global-nav" data-nav-target="panel" data-turbo-permanent class="fixed inset-y-0 left-0 z-50 w-64 md:w-[15rem] bg-bp-darker flex flex-col py-8 px-6 print:hidden space-y-8 shadow-xl shadow-black/50 transform transition-transform duration-200 -translate-x-full md:translate-x-0 overflow-y-auto md:bottom-0 md:top-0 font-rc-full" aria-hidden="true">
    <div class="flex items-center justify-between md:block">
        <a class="text-center md:block" href="<%= user_logged_in? ? landing_path : root_path %>">
            <p class="text-3xl md:text-4xl font-rcgl-full">Blueprint</p>
        </a>
        <button type="button"
                class="p-2 -m-2 md:hidden"
                aria-label="Close menu"
                data-action="click->nav#close">
            <%= inline_svg "icons/close.svg", class: "size-6" %>
        </button>
    </div>
    <div class="flex flex-col space-y-3 grow">
        <% nav_links.each do |name, path| %>
            <% next if path.nil? %>
            <% match = ["Guides", "Blueprint Docs"].include?(name) ? "prefix" : "exact" %>

            <% if name == "Blueprint Docs" %>
                <div class="flex flex-col btn btn-nav hover:bg-bp-dark py-0! px-0! gap-0! text-base" data-nav-target="link" data-nav-match="prefix" data-nav-base="/docs">
                    <%= render "shared/button", url: path, text: name, variant: :none, class: "text-base py-0 nav-submenu-btn" %>
                    <ul data-nav-target="submenu" data-submenu-base="/docs" class="flex-col hidden w-full pb-3 space-y-1 text-sm text-center">
                        <% index_meta = docs_meta_for_url(docs_path) %>
                        <li class="w-full px-2 hover:bg-bp-lighter motion-safe:transition-colors">
                          <a href="<%= docs_path %>" data-nav-target="sublink" data-nav-match="exact" title="<%= index_meta&.dig(:description) %>"><%= index_meta&.dig(:title) || "Start here" %></a>
                        </li>
                        <% docs_menu_items.each do |item| %>
                          <li class="w-full px-2 hover:bg-bp-lighter motion-safe:transition-colors">
                            <a href="<%= item[:path] %>" data-nav-target="sublink" data-nav-match="prefix" title="<%= item[:description] %>"><%= item[:title] %></a>
                          </li>
                        <% end %>
                    </ul>
                </div>
            <% elsif name == "Guides" %>
                <div class="flex flex-col btn btn-nav text-base py-1.5!" data-nav-target="link" data-nav-match="prefix" data-nav-base="/guides">
                    <%= render "shared/button", url: path, text: name, variant: :none, class: "text-base py-0" %>
                    <ul class="flex-col hidden pb-3 space-y-1 text-sm text-center">
                        <% guides_menu_items.each do |item| %>
                          <li>
                            <a href="<%= item[:path] %>" data-nav-target="sublink" data-nav-match="prefix" title="<%= item[:description] %>"><%= item[:title] %></a>
                          </li>
                        <% end %>
                    </ul>
                </div>
            <% else %>
                <%= render "shared/button", url: path, text: name, variant: current_nav == name ? :nav_active : :nav, class: "text-base py-1.5 #{name == "Admin" ? "text-orange-400 border-orange-400" : ""}", html_options: { data: { nav_target: "link", nav_match: match } } %>
            <% end %>
            
        <% end %>
    </div>
    <% if user_logged_in? %>
        <div class="flex flex-col space-y-1">
            <% if session[:original_id] %>
                <%= button_to admin_stop_impersonating_path, method: :post, class: "text-bp-warning text-sm mb-2 cursor-pointer", form: { data: { turbo: false } } do %>
                    <span>Stop Impersonating</span>
                <% end %>
            <% end %>
            <%= link_to user_path(current_user), class: "flex items-center space-x-4" do %>
                <div class="flex items-center space-x-4">
                    <% avatar_url = current_user.avatar || "https://hc-cdn.hel1.your-objectstorage.com/s/v3/c283ae01214b9052480f1e216e43dbe09a424048_image.png" %>
                    <% name = current_user.display_name || current_user.email || "unknown" %>
                    <img src="<%= avatar_url %>" alt="<%= name %>'s avatar" class="rounded-lg size-12">
                    <div>
                        <p class="w-32 truncate whitespace-nowrap"><%= name %> <%= current_user.created_at < DateTime.new(2025,10,4,4,0,0) ? "ðŸš€" : "" %></p>
                        <% cache [
                          current_user,
                          "tickets",
                          current_user.received_build_reviews.maximum(:updated_at),
                          current_user.received_build_reviews.count,
                          current_user.manual_ticket_adjustments.maximum(:updated_at),
                          current_user.manual_ticket_adjustments.count,
                          current_user.shop_orders.maximum(:updated_at),
                          current_user.shop_orders.count
                        ] do %>
                          <p><%= pluralize(current_user.tickets, "ticket") %></p>
                        <% end %>
                    </div>
                </div>
            <% end %>
            <%= button_to logout_path , method: :delete, class: "flex items-center space-x-2" do %>
                <span>Log out</span>
                <%= inline_svg "icons/logout.svg", class: "size-2" %>
            <% end %>
        </div>
    <% else %>
        <%= render "shared/button", url: login_path(redirect_to: request.fullpath), text: "Log in" %>
    <% end %>
</nav>
