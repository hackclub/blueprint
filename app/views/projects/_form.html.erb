<%= form_with model: @project, html: { class: "space-y-6", data: { controller: "project-validator", project_validator_project_id_value: @project.id } } do |f| %>
  <% if @project.errors.any? %>
    <div class="p-4 text-red-900 rounded-md bg-bp-danger">
      <p><strong><%= pluralize(@project.errors.count, "error") %></strong> prevented this project from being saved:</p>
      <ul class="pl-5 list-disc">
        <% @project.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= f.label :title, class: "block text-xl font-medium font-rc-full" %>
    <%= f.text_field :title,
          required: true,
          class: "input px-3 w-full" %>
  </div>

  <div>
    <%= f.label :description, class: "block text-xl font-medium font-rc-full" %>
    <%= f.text_area :description,
          required: true,
          rows: 6,
          class: "input px-3 mt-1 block w-full" %>
  </div>

  <div>
    <%= f.label :repo_link, "Repo Link (optional)", class: "block text-xl font-medium font-rc-full" %>
    <%= f.text_field :repo_link,
          placeholder: "https://github.com/...",
          class: "input px-3 mt-1 block w-full" %>
  </div>

  <div>
    <%= f.label :demo_picture, "Banner image", class: "block text-xl font-medium font-rc-full" %>
    <p>This will be your project's banner.</p>
    <div data-controller="image-preview">
      <div class="my-4">
        <% if @project.demo_picture.attached? %>
          <% if @project.demo_picture.content_type == "image/svg+xml" %>
            <%= image_tag @project.demo_picture, class: "rounded border border-bp-muted/40 max-h-64 object-contain", data: { image_preview_target: "preview" } %>
          <% else %>
            <%= image_tag @project.demo_picture.variant(:web), class: "rounded border border-bp-muted/40 max-h-64 object-contain", data: { image_preview_target: "preview" } %>
          <% end %>
        <% else %>
          <img src="" class="hidden rounded border border-bp-muted/40 max-h-64 object-contain" data-image-preview-target="preview">
          <span class="text-sm text-gray-400" data-image-preview-target="placeholder">No image selected</span>
        <% end %>
      </div>
      <div class="flex items-center mt-1">
        <%= f.file_field :demo_picture, 
              direct_upload: true, 
              accept: "image/*",
              class: "hidden",
              data: { 
                image_preview_target: "input",
                action: "change->image-preview#preview"
              } %>
        <button type="button" 
                class="btn btn-outline" 
                data-image-preview-target="button"
                data-action="click->image-preview#trigger">
          <%= @project.demo_picture.attached? ? "Replace image" : "Choose file" %>
        </button>
        <span class="ml-3" 
              data-image-preview-target="filename" 
              data-placeholder="No file selected">No file selected</span>
      </div>
    </div>
  </div>

  <% if current_user.is_pro %>
    <div data-controller="ysws">
      <%= f.label :ysws, "Are you following a guide?", class: "block text-xl font-medium font-rc-full" %>
      <div class="mt-2 space-y-2">
        <div class="w-full text-left text-white select bg-bp-dark">
          <% ysws_options = Project.guide_options %>
          <% predefined_values = ysws_options.map { |label, value| value } %>
          <% current_ysws = @project.ysws.presence %>
          <% selected_value = current_ysws.nil? ? "none" : (predefined_values.include?(current_ysws) ? current_ysws : "other") %>
          <% other_value = (current_ysws && !predefined_values.include?(current_ysws)) ? current_ysws : nil %>
          <%= f.select :ysws, ysws_options, { selected: selected_value }, { data: { ysws_target: "select", action: "change->ysws#toggle" }, class: "text-white bg-bp-dark", style: "color: white; background-color: var(--color-bp-dark);" } %>
        </div>
        <div class="<%= other_value ? '' : 'hidden' %>" data-ysws-target="otherField">
          <%= f.label :ysws_other, "Please specify:", class: "block text-xl mb-1" %>
          <%= f.text_field :ysws_other, value: other_value, data: { ysws_target: "otherInput", action: "input->ysws#validate" }, class: "input px-3 w-full", placeholder: "Enter name of the guide..." %>
        </div>
      </div>
    </div>
  <% end %>

  <div data-controller="funding-amount"
    data-funding-amount-tier-max-cents-value="<%= { 1 => 40000, 2 => 20000, 3 => 10000, 4 => 5000, 5 => 2500 }.to_json %>">
    <% if @project.ysws != "hackpad" %>
      <div class="space-y-6">
        <div>
          <div>
            <%= f.label :tier, "What tier should this project be?", class: "block text-xl font-medium font-rc-full" %>
            <p class="text-lg">We may adjust this as we see fit.<br>If you're unsure what to pick, check the <a href="/docs" target="_blank" class="underline text-bp-warning">tier docs</a>.</p>
          </div>
          <div class="w-full text-left text-white select bg-bp-dark">
            <%= f.select :tier, Project.tier_options, { include_blank: false, selected: @project.tier || 5 }, { class: "text-white bg-bp-dark", style: "color: white; background-color: var(--color-bp-dark);", data: { funding_amount_target: "tierSelect", action: "change->funding-amount#tierChanged" } } %>
          </div>
        </div>
        <div>
          <%= f.label :funding_needed, "How much funding do you need?", class: "block text-xl font-medium font-rc-full" %>
          <p>You do not need to spend up to your tier maximum.</p>
          <div class="relative">
            <span class="absolute text-lg -translate-y-1/2 left-3 top-1/2">$</span>
            <input type="text"
              placeholder="0.00"
              data-funding-amount-target="input"
              data-action="input->funding-amount#formatInput"
              class="w-full pl-8 input"
              value="<%= @project.funding_needed_cents > 0 ? '%.2f' % (@project.funding_needed_cents / 100.0) : '' %>">
            <%= f.hidden_field :funding_needed_cents, data: { funding_amount_target: "hidden" }, value: @project.funding_needed_cents %>
          </div>
          <p class="hidden text-sm text-bp-danger" data-funding-amount-target="error"></p>
        </div>
      </div>
    <% end %>

    <div class="mt-6">
      <%= f.submit (@project.new_record? ? "Create project" : "Update project"), class: "btn btn-primary block w-full", data: { funding_amount_target: "submit" } %>
    </div>
  </div>
<% end %>
