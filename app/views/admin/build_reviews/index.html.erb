<div class="mb-10">
  <%= render "shared/button", text: "Back", url: admin_root_path, class: "py-0" %>
</div>
<section class="space-y-6">
  <div class="flex flex-col space-y-8">
    <div class="flex flex-col">
      <h1 class="pb-2 text-4xl">Pending Build Review</h1>
      <% if current_user.admin? %>
        <p class="text-bp-warning">Yellow: Pre-reviewed by a reviewer</p>
      <% end %>
      <p class="underline">Underline: US submission</p>
      <p class="text-white/50">Grayed out: Claimed by another reviewer</p>
    </div>
    <div class="grow flex gap-8">
      <% if @top_reviewers_week.present? && @top_reviewers_week.any? %>
        <div>
          <h2 class="text-2xl">Top Reviewers (This Week)</h2>
          <div class="grid grid-cols-6">
            <% @top_reviewers_week.each do |reviewer| %>
              <p class="col-span-5"><%= reviewer.display_name %></p>
              <p><%= pluralize(reviewer.reviews_count, "review") %></p>
            <% end %>
          </div>
        </div>
      <% end %>
      <% if @top_reviewers_all_time.present? && @top_reviewers_all_time.any? %>
        <div>
          <h2 class="text-2xl">Top Reviewers (All Time)</h2>
          <div class="grid grid-cols-6">
            <% @top_reviewers_all_time.each do |reviewer| %>
              <p class="col-span-5"><%= reviewer.display_name %></p>
              <p><%= pluralize(reviewer.reviews_count, "review") %></p>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
  <div class="flex items-center justify-between">
    <div class="flex flex-wrap items-center gap-2">
      <% total_all = @ysws_total_counts.values.sum %>
      <% first_passed_all = @ysws_first_passed_counts.values.sum %>
      <%= render "shared/button", text: "Start Session (<span class='text-bp-warning'>#{first_passed_all}</span>/#{total_all})".html_safe, url: admin_next_build_review_path, class: "py-0" %>
      <% %w[hackpad squeak devboard midi splitkb led custom].each do |type| %>
        <% key = type == "custom" ? nil : type %>
        <% total = @ysws_total_counts[key] || 0 %>
        <% first_passed = @ysws_first_passed_counts[key] || 0 %>
        <%= render "shared/button", text: "#{type.capitalize} (<span class='text-bp-warning'>#{first_passed}</span>/#{total})".html_safe, url: admin_next_build_review_path(ysws_type: type), variant: :outline, class: "py-0" %>
      <% end %>
    </div>
    <%= form_with url: admin_projects_path, method: :get, local: true, class: "w-full max-w-2xl" do %>
      <div class="flex items-center gap-3">
        <input type="text" name="q" value="<%= h(@q) %>" placeholder="Search by ID, title, or author" class="w-full text-white border-white rounded-none input bg-bp-darker placeholder-white/60" />
        <button type="submit" class="text-lg rounded-none btn btn-primary">Search</button>
      </div>
    <% end %>
  </div>

  <div class="border-2 border-white rounded-none">
    <!-- Header row -->
    <div class="grid grid-cols-24 p-3 text-lg border-b-2 border-white">
      <div class="col-span-1">ID</div>
      <div class="col-span-3">Title</div>
      <div class="col-span-4">Description</div>
      <div class="col-span-2">Author</div>
      <div class="col-span-2">Type</div>
      <div class="col-span-1">Tier</div>
      <div class="col-span-2">Hours</div>
      <div class="col-span-2">Entries</div>
      <div class="col-span-2">Waiting</div>
      <div class="col-span-1">Actions</div>
    </div>

    <!-- Rows -->
    <% if @projects.present? %>
      <% now = Time.current %>
      <% @projects.each do |project| %>
        <%
          claimed_by_other = project.build_review_claimed_by.present? &&
                             project.build_review_claimed_by_id != current_user.id &&
                             project.build_review_claimed_at.present? &&
                             project.build_review_claimed_at >= @claim_cutoff
          row_classes = claimed_by_other ? "opacity-50" : ""
        %>
        <div class="grid grid-cols-24 px-3 py-3 text-lg border-b border-white/30 last:border-0 <%= row_classes %>">
          <div class="flex items-center col-span-1"><%= project.id %></div>
          <div class="flex flex-col col-span-3 font-medium gap-3 pr-4">
            <% 
              base_classes = "underline-offset-2"
              us_classes = "underline"
              is_us = project.user.us?
              link_classes = is_us ? "#{base_classes} #{us_classes}" : base_classes
            %>
            <% if current_user.admin? %>
              <%= link_to (project.title.presence || "(untitled)"), admin_build_review_path(project), class: "#{link_classes} #{project.pre_reviewed ? 'text-bp-warning' : ''} truncate" %>
            <% else %>
              <%= link_to (project.title.presence || "(untitled)"), admin_build_review_path(project), class: "#{link_classes} truncate" %>
            <% end %>
            <% if project.display_banner %>
              <%= image_tag url_for(project.display_banner), class: "h-32 rounded-sm object-cover shrink-0" %>
            <% end %>
          </div>
          <div class="flex items-center col-span-4 pr-4">
            <p class="text-sm text-white/80 line-clamp-4"><%= project.description %></p>
          </div>
          <div class="flex items-center col-span-2 gap-2">
            <% if project.user %>
              <img src="<%= project.user.avatar_url %>" alt="<%= project.user.display_name %>" class="size-12 rounded-sm shrink-0" />
              <%= link_to project.user.display_name, admin_user_path(project.user), class: "underline decoration-white/30 underline-offset-2 hover:decoration-white truncate" %>
            <% else %>
              <p>–</p>
            <% end %>
          </div>
          <div class="flex items-center col-span-2">
            <%= project.ysws || "Custom" %>
          </div>
          <div class="flex items-center col-span-1">
            <%= project.tier || "–" %>
          </div>
          <div class="flex items-center col-span-2">
            <%= (project[:hours_since_last_review_seconds].to_f / 3600.0).round(1) %>
          </div>
          <div class="flex items-center col-span-2">
            <%= project[:entries_since_last_review_count].to_i %>
          </div>
          <div class="flex items-center col-span-2">
            <% start_time = project[:waiting_since] %>
            <% if start_time %>
              <% waiting_time = now - start_time %>
              <% days = (waiting_time / 1.day).floor %>
              <% hours_remaining = ((waiting_time % 1.day) / 1.hour).floor %>
              <% if days > 0 %>
                <%= "#{days}d #{hours_remaining}h" %>
              <% else %>
                <%= "#{hours_remaining}h" %>
              <% end %>
            <% else %>
              –
            <% end %>
          </div>
          <div class="flex flex-col items-start col-span-1 gap-1">
            <div class="flex items-center gap-2">
              <%= render "shared/button", text: "Review", url: admin_build_review_path(project), class: "text-sm py-0 px-2" %>
            </div>
            <% if claimed_by_other %>
              <span class="text-xs text-white/60">Claimed by <%= project.build_review_claimed_by.display_name %></span>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="px-4 py-6 text-center text-white/70">No projects found.</div>
    <% end %>
  </div>

  <div class="flex items-center justify-end text-lg">
    <%== pagy_nav(@pagy) if @pagy.present? && @pagy.pages > 1 %>
  </div>
</section>
