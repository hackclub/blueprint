<section class="space-y-6">
  <%= render "shared/button", text: "Back", url: admin_users_path, class: "py-0" %>
  <div class="flex items-center justify-between">
    <h1 class="pb-2 text-4xl">User #<%= @user.id %>, <%= render "shared/user_inline", avatar_classes: "size-10 -mt-2", user: @user %></h1>
  </div>
  <div class="grid grid-cols-2 gap-8">
    <%= render "shared/card", class: "space-y-2" do %>
      <p class="text-2xl font-rc-full">User information</p>
      <div>
        <p>ID: <%= @user.id %></p>
        <p>Username: <%= @user.username || "-" %> (<%= @user.display_name %>)</p>
        <% if current_user.admin? %>
          <p>Email: <a class="underline" href="mailto:<%= @user.email %>"><%= @user.email %></a></p>
        <% end %>
        <p>Slack ID: <%= @user.slack_id %></p>
        <p>GitHub username: <a class="underline" href="https://github.com/<%= @user.github_username %>"><%= @user.github_username %></a></p>
        <% if current_user.admin? %>
          <p>Timezone: <%= @user.timezone || "Not set" %></p>
        <% end %>
        <p>Joined: <%= @user.created_at %></p>
        <p>Last active: <%= @user.last_active || "Never" %></p>
        <p>Updated: <%= @user.updated_at %></p>
      </div>
    <% end%>
    <%= render "shared/card", class: "space-y-2" do %>
      <p class="text-2xl font-rc-full">User stats</p>
      <div>
        <%= render "admin/pill", type: :boolean, value: @user.is_banned do %>
          <p>Banned:</p>
        <% end %>
        <%= render "admin/pill", type: :boolean, value: @user.admin? do %>
          <p>Admin:</p>
        <% end %>
        <%= render "admin/pill", type: :boolean, value: @user.reviewer? do %>
          <p>Reviewer:</p>
        <% end %>
        <%= render "admin/pill", type: :boolean, value: @user.fulfiller? do %>
          <p>Fulfiller:</p>
        <% end %>
        <%= render "admin/pill", type: :boolean, value: @user.is_mcg? do %>
          <p>MCG:</p>
        <% end %>
      </div>
      <div>
        <p>Projects: <%= @user.projects.count %> (<%= @user.projects.where.not(review_status: nil).count %> shipped)</p>
        <p>Journal entries: <%= @user.journal_entries.count %></p>
        <p>Total hours: <%= @user.journal_entries.sum(:duration_seconds) / 3600 %> (<%= @user.journal_entries.joins(:project).where.not(projects: { review_status: nil }).sum(:duration_seconds) / 3600 %> shipped)</p>
        <p>Following: <%= @user.followed_projects.count %></p>
        <p>Referred: <%= @user.eligible_referral_count %></p>
      </div>
    <% end %>
    <% if current_user.admin? %>
      <%= render "shared/card", class: "space-y-4 col-span-2" do %>
        <p class="text-2xl font-rc-full">Actions</p>
        <div class="flex flex-wrap gap-4">
          <% if current_user != @user %>
            <%= render "shared/button",
                  variant: :none,
                  text: @user.admin? ? "Revoke Admin" : "Grant Admin",
                  url: @user.admin? ? revoke_admin_admin_user_path(@user) : grant_admin_admin_user_path(@user),
                  html_options: { data: { turbo_method: :post, turbo_confirm: @user.admin? ? "Revoke admin permissions?" : "Grant admin permissions? This gives full system access!" } },
                  class: @user.admin? ? "btn border-bp-danger bg-bp-danger cursor-pointer text-white" : "btn border-bp-success bg-bp-success cursor-pointer text-bp-dark"
                %>
            
            <%= render "shared/button",
                  variant: :none,
                  text: @user.reviewer? ? "Revoke Reviewer" : "Grant Reviewer",
                  url: @user.reviewer? ? revoke_reviewer_admin_user_path(@user) : grant_reviewer_admin_user_path(@user),
                  html_options: { data: { turbo_method: :post, turbo_confirm: @user.reviewer? ? "Revoke reviewer permissions?" : "Grant reviewer permissions?" } },
                  class: @user.reviewer? ? "btn border-bp-danger bg-bp-danger cursor-pointer text-white" : "btn border-bp-success bg-bp-success cursor-pointer text-bp-dark"
                %>
            
            <%= render "shared/button",
                  variant: :none,
                  text: @user.fulfiller? ? "Revoke Fulfiller" : "Grant Fulfiller",
                  url: @user.fulfiller? ? revoke_fulfiller_admin_user_path(@user) : grant_fulfiller_admin_user_path(@user),
                  html_options: { data: { turbo_method: :post, turbo_confirm: @user.fulfiller? ? "Revoke fulfiller permissions?" : "Grant fulfiller permissions?" } },
                  class: @user.fulfiller? ? "btn border-bp-danger bg-bp-danger cursor-pointer text-white" : "btn border-bp-success bg-bp-success cursor-pointer text-bp-dark"
                %>

            <%= render "shared/button",
                  variant: :none,
                  text: @user.shopkeeper? ? "Revoke Shopkeeper" : "Grant Shopkeeper",
                  url: @user.shopkeeper? ? revoke_shopkeeper_admin_user_path(@user) : grant_shopkeeper_admin_user_path(@user),
                  html_options: { data: { turbo_method: :post, turbo_confirm: @user.shopkeeper? ? "Revoke shopkeeper permissions?" : "Grant shopkeeper permissions?" } },
                  class: @user.shopkeeper? ? "btn border-bp-danger bg-bp-danger cursor-pointer text-white" : "btn border-bp-success bg-bp-success cursor-pointer text-bp-dark"
                %>

            <%= render "shared/button",
                  variant: :none,
                  text: @user.is_banned? ? "Unban" : "Ban",
                  url: @user.is_banned? ? unban_admin_user_path(@user) : ban_admin_user_path(@user),
                  html_options: { data: { turbo_method: :post, turbo_confirm: @user.is_banned? ? "Unban this user?" : "Ban this user?" } },
                  class: @user.is_banned? ? "btn border-bp-success bg-bp-success cursor-pointer text-bp-dark" : "btn border-bp-danger bg-bp-danger cursor-pointer text-white"
                %>
          <% end %>
          <% if @user != current_user && !@user.admin? && !@user.special_perms? %>
            <%= render "shared/button",
                  variant: :none,
                  text: "Impersonate",
                  url: impersonate_admin_user_path(@user),
                  html_options: { data: { turbo_method: :post, turbo_confirm: "Are you sure you want to impersonate this user?" } },
                  class: "btn border-blue-500 bg-blue-500 cursor-pointer text-white"
                %>
          <% end %>
          <button type="button" data-controller="modal" data-modal-target-id-value="ticketOverride" data-action="click->modal#show" class="btn border-amber-500 bg-amber-500 cursor-pointer text-white">
            Ticket Override (<%= @user.tickets %>)
          </button>
        </div>
        <div id="ticketOverrideModal" data-controller="modal" data-action="modal:show-ticketOverride@window->modal#show modal:hide-ticketOverride@window->modal#hide" class="hidden fixed inset-0 z-50 flex items-center justify-center" data-modal-overlay-target="overlay">
          <div class="absolute inset-0 bg-black/50" data-modal-target="overlay"></div>
          <div class="relative bg-bp-dark border border-white/10 rounded-lg p-6 w-full max-w-md" data-modal-target="panel">
            <h3 class="text-xl font-rc-full mb-4">Ticket Override</h3>
            <p class="mb-4 text-white/70">Current tickets: <span class="font-bold text-white"><%= @user.tickets %></span></p>
            <%= form_with url: add_ticket_adjustment_admin_user_path(@user), method: :post, local: true, class: "space-y-4" do |f| %>
              <div>
                <label class="block text-sm mb-1">Adjustment (positive to add, negative to remove)</label>
                <input type="number" name="adjustment" value="0" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white" required>
              </div>
              <div>
                <label class="block text-sm mb-1">Internal Reason</label>
                <input type="text" name="reason" placeholder="Reason for adjustment..." class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded text-white" required>
              </div>
              <div class="flex gap-2 justify-end">
                <button type="button" data-action="click->modal#hide" class="btn border-white/20 bg-white/10 cursor-pointer text-white">Cancel</button>
                <button type="submit" class="btn border-bp-success bg-bp-success cursor-pointer text-bp-dark">Apply</button>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
    <%= render "shared/card", class: "space-y-4 col-span-2" do %>
      <p class="text-2xl font-rc-full">Internal notes</p>
      <%= render "admin/users/user_notes_form", user: @user %>
    <% end %>
    <%= render "shared/card", class: "space-y-2 col-span-2" do %>
      <p class="text-2xl font-rc-full">Projects</p>
      <details>
        <summary>Show projects</summary>
        <ul class="list-disc list-inside">
          <% @user.projects.each do |project| %>
            <li><%= link_to project.title, admin_project_path(project), class: "underline" %> - <%= project.review_status || "not_submitted" %> - <% pluralize(project.journal_entries.sum(:duration_seconds) / 3600, "hour") %></li>
          <% end %>
        </ul>
      </details>
    <% end %>
    <% if current_user.admin? %>
      <%= render "shared/card", class: "space-y-2 col-span-2" do %>
        <p class="text-2xl font-rc-full">Audit log</p>
        <%= render "admin/audit_log", object: @user %>
      <% end %>
    <% end %>
  </div>
</section>