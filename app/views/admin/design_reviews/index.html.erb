<div class="mb-10">
  <%= render "shared/button", text: "Back", url: admin_root_path, class: "py-0" %>
</div>
<section class="space-y-6">
  <div class="flex flex-col space-y-8">
    <div class="flex flex-col">
      <h1 class="pb-2 text-4xl">Pending Design Review</h1>
      <% if current_user.admin? %>
        <p class="text-bp-warning">Yellow: Pre-reviewed by a reviewer</p>
      <% end %>
      <p class="underline">Underline: US submission</p>
    </div>
    <div class="grow max-w-xl">
      <% if @top_reviewers.present? && @top_reviewers.any? %>
        <h2 class="text-2xl">Top Reviewers (Last 7 Days)</h2>
        <div class="grid grid-cols-6">
          <% @top_reviewers.each do |reviewer| %>
            <p class="col-span-5"><%= reviewer.display_name %></p>
            <p><%= pluralize(reviewer.reviews_count, "review") %></p>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="flex items-center justify-between">
    <div class="flex flex-wrap items-center gap-2">
      <%= render "shared/button", text: "Random", url: admin_random_design_review_path, class: "py-0" %>
      <%= render "shared/button", text: "Hackpad", url: admin_random_design_review_path(ysws_type: "hackpad"), variant: :outline, class: "py-0" %>
      <%= render "shared/button", text: "Squeak", url: admin_random_design_review_path(ysws_type: "squeak"), variant: :outline, class: "py-0" %>
      <%= render "shared/button", text: "Devboard", url: admin_random_design_review_path(ysws_type: "devboard"), variant: :outline, class: "py-0" %>
      <%= render "shared/button", text: "Midi", url: admin_random_design_review_path(ysws_type: "midi"), variant: :outline, class: "py-0" %>
      <%= render "shared/button", text: "Splitkb", url: admin_random_design_review_path(ysws_type: "splitkb"), variant: :outline, class: "py-0" %>
      <%= render "shared/button", text: "LED", url: admin_random_design_review_path(ysws_type: "led"), variant: :outline, class: "py-0" %>
      <%= render "shared/button", text: "Custom", url: admin_random_design_review_path(ysws_type: "custom"), variant: :outline, class: "py-0" %>
    </div>
    <%= form_with url: admin_projects_path, method: :get, local: true, class: "w-full max-w-2xl" do %>
      <div class="flex items-center gap-3">
        <input type="text" name="q" value="<%= h(@q) %>" placeholder="Search by ID, title, or author" class="w-full text-white border-white rounded-none input bg-bp-darker placeholder-white/60" />
        <button type="submit" class="text-lg rounded-none btn btn-primary">Search</button>
      </div>
    <% end %>
  </div>

  <div class="border-2 border-white rounded-none">
    <!-- Header row -->
    <div class="grid grid-cols-12 p-3 text-lg border-b-2 border-white">
      <div class="col-span-1">ID</div>
      <div class="col-span-2">Title</div>
      <div class="col-span-1">Author</div>
      <div class="col-span-1">Type</div>
      <div class="col-span-1">Tier</div>
      <div class="col-span-1">Cost</div>
      <div class="col-span-1">Hours</div>
      <div class="col-span-1">CPH</div>
      <div class="col-span-1">Entries</div>
      <div class="col-span-1">Waiting</div>
      <div class="col-span-1">Actions</div>
    </div>

    <!-- Rows -->
    <% if @projects.present? %>
      <% @projects.each do |project| %>
        <div class="grid grid-cols-12 px-3 text-lg border-b border-white/30 last:border-0">
          <div class="flex items-center col-span-1 py-2"><%= project.id %></div>
          <div class="flex items-center col-span-2 font-medium">
            <% 
              base_classes = "underline-offset-2"
              us_classes = "underline"
              is_us = project.user.us?
              link_classes = is_us ? "#{base_classes} #{us_classes}" : base_classes
            %>
            <% if current_user.admin? %>
              <%= link_to (project.title.presence || "(untitled)"), admin_design_review_path(project), class: "#{link_classes} #{project.pre_reviewed ? 'text-bp-warning' : ''}" %>
            <% else %>
              <%= link_to (project.title.presence || "(untitled)"), admin_design_review_path(project), class: link_classes %>
            <% end %>
          </div>
          <div class="flex items-center col-span-1">
            <% if project.user %>
              <%= link_to project.user.display_name, admin_user_path(project.user), class: "underline decoration-white/30 underline-offset-2 hover:decoration-white" %>
            <% else %>
              <p>–</p>
            <% end %>
          </div>
          <div class="flex items-center col-span-1">
            <%= project.ysws || "Custom" %>
          </div>
          <div class="flex items-center col-span-1">
            <%= project.tier || "No grant" %>
          </div>
          <div class="flex items-center col-span-1">
            <%= sprintf("%.2f", project.funding_needed_cents / 100.0) %>
          </div>
          <div class="flex items-center col-span-1">
            <% hours = (project.journal_entries.map(&:duration_seconds).sum / 3600.0).round(1) %>
            <%= hours %>
          </div>
          <div class="flex items-center col-span-1">
            <% cost = project.funding_needed_cents / 100.0 %>
            <% if hours > 0 %>
              <%= sprintf("%.2f", cost / hours) %>
            <% else %>
              –
            <% end %>
          </div>
          <div class="flex items-center col-span-1">
            <%= project.journal_entries.size %>
          </div>
          <div class="flex items-center col-span-1">
            <% 
              start_time = nil
              
              if project.respond_to?(:versions)
                events = attribute_updated_event(object: project, attribute: :review_status, after: "design_pending", all: true)
                start_time = events.last[:timestamp] if events.present?
              end
            %>
            
            <% if start_time %>
              <% waiting_time = Time.current - start_time %>
              <% days = (waiting_time / 1.day).floor %>
              <% hours_remaining = ((waiting_time % 1.day) / 1.hour).floor %>
              <% if days > 0 %>
                <%= "#{days}d #{hours_remaining}h" %>
              <% else %>
                <%= "#{hours_remaining}h" %>
              <% end %>
            <% else %>
              Error
            <% end %>
          </div>
          <div class="flex items-center col-span-1">
            <div class="flex items-center gap-2">
              <%= render "shared/button", text: "Review", url: admin_design_review_path(project), class: "text-sm py-0 px-2" %>
            </div>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="px-4 py-6 text-center text-white/70">No projects found.</div>
    <% end %>
  </div>

  <div class="flex items-center justify-end text-lg">
    <%== pagy_nav(@pagy) if @pagy.present? && @pagy.pages > 1 %>
  </div>
</section>
