<section class="space-y-6">
  <% if @claimed_by_other %>
    <div class="bg-bp-warning/20 border-2 border-bp-warning text-bp-warning p-4 rounded">
      <p class="font-bold text-xl">⚠️ This project is currently being reviewed by <%= @project.design_review_claimed_by.display_name %></p>
      <p class="mt-2">Their claim will expire in approximately <%= distance_of_time_in_words(@project.design_review_claimed_at + 20.minutes, Time.current) %>. You can still view the project, but the review form is disabled.</p>
      <div class="mt-4">
        <%= render "shared/button", text: "Skip to Next Project", url: admin_next_design_review_path(after: @project.id), class: "py-1" %>
      </div>
    </div>
  <% end %>
  <div class="flex items-center justify-between">
    <%= render "shared/button", text: "Back", url: admin_design_reviews_path, class: "py-0" %>
    <div class="flex items-center gap-2">
      <%= render "shared/button", text: "HCB", url: "https://hcb.hackclub.com/ysws-blueprint/card_grants/card_overview?q=#{ERB::Util.url_encode(@project.user.email)}&event_id=ysws-blueprint", class: "py-0", variant: :outline %>
      <% if current_user&.admin? %>
        <% button_label = case @project.review_status
          when "design_pending" then "Move to Build Queue"
          when "design_needs_revision" then "Move to Build Needs-Revision"
          when "build_pending" then "Move to Design Queue"
          when "build_needs_revision" then "Move to Design Needs-Revision"
          when "design_approved" then "Open Build Review"
          else nil
          end %>
        <% if button_label.present? %>
          <%= button_to button_label, switch_review_phase_admin_project_path(@project), method: :post, class: "btn btn-primary bg-bp-warning text-bp-dark border-bp-warning", data: { turbo_confirm: "Are you sure? This will change the queue and may invalidate prior reviews for that phase and notify the user." } %>
        <% end %>
      <% end %>
    </div>
  </div>
  <%= render "shared/card" do %>
        <% if @project.display_banner %>
        <div class="shrink-0">
          <%= image_tag url_for(@project.display_banner), class: "w-full h-72 object-cover rounded-lg" %>
        </div>
      <% end %>
    <div class="flex gap-6">
      <div class="flex flex-col justify-between space-y-1 flex-1">
        <h1 class="pb-2 text-4xl">Project #<%= @project.id %>, <%= link_to @project.title, admin_project_path(@project), class: "underline" %></h1>
        <div>
          <p>By <%= render "shared/user_inline", user: @project.user, admin_view: true %> on <%= @project.created_at.strftime("%B %d, %Y") %></p>
        </div>
      <div class="flex justify-start text-xl mt-4">
        <% if @project.tier.present? %>
          <% tier_style = @project.tier == "1" ? "bg-bp-danger text-bp-darker" : (@project.tier == "2" ? "bg-bp-warning text-bp-darker" : (@project.tier == "3" ? "bg-bp-success text-bp-darker" : "bg-bp-dark text-white")) %>
          <p>Tier: <span class="<%= tier_style %> p-1 px-3 "><%= @project.tier %></span></p>
        <% end %>
      </div>
      <p class="text-xl">Requesting: $<%= sprintf("%.2f", @project.funding_needed_cents / 100.0) %></p>
      <% hours = (@project.journal_entries.sum(:duration_seconds) / 3600.0).round(1) %>
      <div class="flex flex-wrap gap-6 text-xl mt-2">
        <p>Type: <span class="font-medium"><%= @project.ysws || "Custom" %></span></p>
        <p>Hours: <span class="font-medium"><%= hours %>h</span></p>
        <%# <p>CPH: <span class="font-medium"><%= hours > 0 ? sprintf("$%.2f", (@project.funding_needed_cents / 100.0) / hours) : "–" </span></p> %>
        <% if @project.ysws == "hackpad" && @project.approx_hour.present? %>
          <p>Self-reported: <span class="font-medium"><%= @project.approx_hour %>h</span></p>
        <% end %>
        </div>
      </div>
    </div>
    <div class="space-y-6">
      <p class="text-xl wrap-break-word"><%= @project.description %></p>

      <div>
        <% if @project.repo_link.present? %>
          <%= render "shared/button", text: "Repository", url: @project.repo_link, class: "py-0", html_options: { target: "_blank" } %>
        <% end %>
        <% if @project.demo_link.present? %>
          <%= render "shared/button", text: "Demo", url: @project.demo_link, class: "py-0", html_options: { target: "_blank" } %>
        <% end %>
      </div>
    </div>
  <% end %>
  <% if @project.ysws == "hackpad" %>
    <% other_hackpads_in_review = @project.user.projects.active.where(ysws: "hackpad", review_status: nil).where.not(id: @project.id) %>
    <% if other_hackpads_in_review.any? %>
      <%= render "shared/card" do %>
        <div class="bg-bp-warning/20 border border-bp-warning text-bp-warning p-4 rounded">
          <p class="font-bold">⚠️ Warning: This user has <%= pluralize(other_hackpads_in_review.count, "other hackpad") %> in review</p>
          <ul class="mt-2 list-disc list-inside">
            <% other_hackpads_in_review.each do |project| %>
              <li><%= link_to project.title, admin_project_path(project), class: "underline" %> (created <%= project.created_at.strftime("%B %d, %Y") %>)</li>
            <% end %>
          </ul>
        </div>
      <% end %>
    <% end %>
  <% end %>
  <%= render "shared/card" do %>
    <p class="text-3xl pb-4 font-rc-full">Previous Reviews</p>
    <div class="flex flex-col divide-y-2">
      <% @project.design_reviews.order(created_at: :desc).each do |review| %>
        <div class="py-4 first:pt-0 last:pb-0 flex space-x-4">
          <div>
            <% if review.invalidated? %>
              <p class="text-bp-danger">OUTDATED</p>
            <% end %>
            <% if review.admin_review? %>
              <p class="text-bp-warning">ADMIN</p>
            <% end %>
            <p>Reviewed by: <%= render "shared/user_inline", user: User.find(review.reviewer_id), admin_view: true %></p>
            <% if review.result == "approved" %>
              <p>Result: <span class="text-bp-success">Approved</span></p>
            <% elsif review.result == "returned" %>
              <p>Result: <span class="text-bp-warning">Returned</span></p>
            <% elsif review.result == "rejected" %>
              <p>Result: <span class="text-bp-danger">Permanently Rejected</span></p>
            <% else %>
              <p>Result: <span>Unknown</span></p>
            <% end %>
            <p>Hours override: <%= review.hours_override || "N/A" %></p>
            <p>Tier override: <%= review.tier_override || "N/A" %></p>
            <p>Grant override: <%= review.grant_override_cents ? "$#{sprintf("%.2f", review.grant_override_cents / 100.0)}" : "N/A" %></p>
            <p>Feedback: <%= review.feedback.present? ? review.feedback : "No feedback given" %></p>
            <p>Reason: <%= review.reason.present? ? review.reason : "No reason given" %></p>
            <p>Reviewed at: <%= review.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
          </div>
          <div>
            <p>Frozen data:</p>
            <p>Funding: <%= review.frozen_funding_needed_cents.present? ? sprintf("%.2f", review.frozen_funding_needed_cents / 100.0) : "Unknown" %></p>
            <p>Tier: <%= review.frozen_tier.present? ? review.frozen_tier : "Unknown" %></p>
            <p>Hours: <%= review.frozen_duration_seconds.present? ? review.frozen_duration_seconds / 3600.0 : "Unknown" %></p>
            <p>Journal entries: <%= review.frozen_entry_count.present? ? review.frozen_entry_count : "Unknown" %></p>
            <p>Note to reviewer: <%= review.frozen_reviewer_note.present? ? review.frozen_reviewer_note : "None" %></p>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <%= render "admin/shared/ai_review_panel", ai_review: @ai_review, project: @project, review_phase: "design" %>

  <% if @project.reviewer_note.present? %>
    <%= render "shared/card" do %>
      <p class="text-3xl pb-4 font-rc-full">Note from Author</p>
      <p class="text-xl"><%= @project.reviewer_note %></p>
    <% end %>
  <% end %>

  <%= render "shared/card" do %>
    <div class="space-y-2">
      <p class="text-3xl font-rc-full">Journal Entries</p>
      <div class="flex space-x-12 text-xl">
        <p>Count: <%= @project.journal_entries.count %></p>
        <p>Total: <%= @project.journal_entries.sum(:duration_seconds) / 3600.0 %>h</p>
        <p>Average: <%= @project.journal_entries.average(:duration_seconds).to_f / 3600.0 %>h</p>
        <p>≥1h: <%= @project.journal_entries.where("duration_seconds >= ?", 3600).count %>/<%= @project.journal_entries.count %></p>
        <p>Max: <%= (@project.journal_entries.maximum(:duration_seconds).to_f / 3600.0) %>h</p>
        <p>Min: <%= (@project.journal_entries.minimum(:duration_seconds).to_f / 3600.0) %>h</p>
      </div>
      <% if @project.journal_entries.count > 1 %>
        <% chart_data = @project.journal_entries.order(:id).pluck(:id, :duration_seconds).map { |id, duration| ["##{id}", duration / 3600.0] }.to_h %>
        <div class="mt-4">
          <%= bar_chart chart_data,
            suffix: " hrs",
            height: "300px",
            colors: ["#ffc857"],
            library: {
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: "Time spent per entry (hours)",
                  color: "white"
                }
              },
              scales: {
                y: {
                  title: {
                    display: true,
                    text: "Entries",
                    color: "white"
                  },
                  ticks: { color: "white" }
                },
                x: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Hours",
                    color: "white"
                  },
                  ticks: { color: "white" }
                }
              }
            } %>
        </div>
      <% end %>
      <div>
        <div data-controller="journal-collapsible">
          <details>
            <summary>Show Entire Journal</summary>
            <div class="mt-4 space-y-6 markdown">
            <% base_url = Rails.application.routes.default_url_options[:host] || "localhost:3000" %>
            <%= sanitize_marksmith_html(Marksmith::Renderer.new(body: @project.generate_journal(true), base_url: "http://#{base_url}").render) %>
            </div>
          </details>
        </div>
      </div>
    </div>
  <% end %>
  <%= render "shared/card" do %>
    <div>
      <p class="text-3xl pb-4 font-rc-full">Cart Screenshots</p>
      <p class="text-xl">Requesting: $<%= sprintf("%.2f", @project.funding_needed_cents / 100.0) %></p>
    </div>
    <% if @project.cart_screenshots.attached? %>
      <div class="flex flex-wrap gap-3 my-4">
        <% @project.cart_screenshots.each do |img| %>
          <div class="h-64 aspect-video overflow-hidden ">
            <%= link_to rails_blob_path(img, disposition: "inline"), target: "_blank", rel: "noopener noreferrer" do %>
              <%= image_tag img, class: "rounded border border-bp-muted/40 w-full h-full object-contain cursor-pointer hover:opacity-80 transition-opacity" %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-xl">No screenshots uploaded.</p>
    <% end %>
  <% end %>

  <%= render "shared/card" do %>
    <p class="text-3xl pb-4 font-rc-full">User Internal Notes</p>
    <%= render "admin/users/user_notes_form", user: @project.user %>
  <% end %>

  <%= render "shared/card" do %>
    <p class="text-3xl pb-4 font-rc-full">Submit Design Review</p>
    <% if @claimed_by_other %>
      <div class="text-white/50 text-lg">
        <p>Review form disabled while another reviewer has this project claimed.</p>
      </div>
    <% end %>
    <fieldset <%= "disabled" if @claimed_by_other %>>
    <%= form_with model: @design_review, url: admin_design_review_create_path(@project), method: :post, html: { class: "space-y-6" } do |f| %>
      <%= hidden_field_tag :ysws_type, params[:ysws_type] if params[:ysws_type].present? %>
      <div>
        <%= f.label :hours_override, "Hours Override", class: "block text-xl font-medium" %>
        <%= f.number_field :hours_override, step: 0.01, placeholder: "Leave blank to use calculated hours (#{@project.journal_entries.sum(:duration_seconds) / 3600.0})", class: "input px-3 mt-1 block w-full" %>
      </div>

      <div>
        <%= f.label :tier_override, "Tier Override", class: "block text-xl font-medium" %>
        <%= f.select :tier_override, Project.tier_options, { include_blank: "Leave blank for default tier (#{@project.tier})" }, class: "input px-3 mt-1 block w-full" %>
      </div>

      <div>
        <%= f.label :grant_override_cents, "Grant Override (cents)", class: "block text-xl font-medium" %>
        <%= f.number_field :grant_override_cents, placeholder: "Leave blank for default (#{@project.funding_needed_cents})", class: "input px-3 mt-1 block w-full" %>
      </div>

      <% if current_user.admin? %>
        <div>
          <%= f.label :ysws, "Guide Override", class: "block text-xl font-medium" %>
          <%= f.select :ysws, Project.guide_options, { selected: @project.ysws || "none", include_blank: false }, class: "input px-3 mt-1 block w-full" %>
        </div>
      <% end %>

      <div>
        <%= f.label :reason, "Internal Justification", class: "block text-xl font-medium" %>
        <%= f.text_area :reason, rows: 4, placeholder: "Justify your decision (why you approved/denied)", class: "input px-3 mt-1 block w-full", required: false %>
      </div>

      <div>
        <%= f.label :feedback, "Feedback for author (MANDATORY)", class: "block text-xl font-medium" %>
        <%= f.text_area :feedback, rows: 4, placeholder: "Give feedback for the author of the project!", class: "input px-3 mt-1 block w-full", required: true %>
      </div>

      <div class="flex gap-4">
        <%= f.button "Approve", type: "submit", name: "design_review[result]", value: "approved", class: "btn btn-primary flex-1 bg-bp-success border-bp-success" %>
        <%= f.button "Return", type: "submit", name: "design_review[result]", value: "returned", class: "btn btn-primary flex-1 bg-bp-warning border-bp-warning" %>
        <%= f.button "Permanently Reject", type: "submit", name: "design_review[result]", value: "rejected", class: "btn btn-primary flex-1 bg-bp-danger border-bp-danger" %>
        <%= link_to "Skip", admin_next_design_review_path(after: @project.id, ysws_type: params[:ysws_type]), class: "btn btn-outline flex-1" %>
      </div>
    <% end %>
    </fieldset>
  <% end %>
</section>